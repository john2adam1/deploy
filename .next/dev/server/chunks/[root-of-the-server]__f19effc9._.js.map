{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/avtotest/proxy.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\"\r\nimport { NextResponse, type NextRequest } from \"next/server\"\r\n\r\n// #region agent log\r\nfetch('http://127.0.0.1:7242/ingest/deddb419-d5fa-4d5c-b0af-a92b16ae4dd2',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({location:'proxy.ts:4',message:'File proxy.ts exports proxy function - correct match',data:{fileName:'proxy.ts',exportName:'proxy',match:'correct'},timestamp:Date.now(),sessionId:'debug-session',runId:'post-fix',hypothesisId:'A'})}).catch(()=>{});\r\n// #endregion\r\n\r\nexport async function proxy(request: NextRequest) {\r\n  try {\r\n    let response = NextResponse.next({\r\n      request: {\r\n        headers: request.headers,\r\n      },\r\n    })\r\n\r\n    // Check if environment variables are set\r\n    if (!process.env.NEXT_PUBLIC_SUPABASE_URL || !process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY) {\r\n      console.error(\"Missing Supabase environment variables\")\r\n      return response\r\n    }\r\n\r\n    const supabase = createServerClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL,\r\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,\r\n      {\r\n        cookies: {\r\n          getAll() {\r\n            return request.cookies.getAll()\r\n          },\r\n          setAll(cookiesToSet) {\r\n            cookiesToSet.forEach(({ name, value }) =>\r\n              request.cookies.set(name, value)\r\n            )\r\n\r\n            response = NextResponse.next({\r\n              request,\r\n            })\r\n\r\n            cookiesToSet.forEach(({ name, value, options }) =>\r\n              response.cookies.set(name, value, options)\r\n            )\r\n          },\r\n        },\r\n      }\r\n    )\r\n\r\n    let user = null\r\n    try {\r\n      const {\r\n        data: { user: authUser },\r\n        error: authError,\r\n      } = await supabase.auth.getUser()\r\n\r\n      if (authError) {\r\n        console.error(\"Auth error in proxy:\", authError.message)\r\n        // Continue without user if auth fails\r\n      } else {\r\n        user = authUser\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Error getting user in proxy:\", error)\r\n      // Continue without user if there's an error\r\n    }\r\n\r\n    // ðŸ”’ Admin route protection\r\n    if (request.nextUrl.pathname.startsWith(\"/admin\") && user) {\r\n      try {\r\n        const { data: userData, error: userError } = await supabase\r\n          .from(\"users\")\r\n          .select(\"role\")\r\n          .eq(\"id\", user.id)\r\n          .single()\r\n\r\n        if (userError) {\r\n          console.error(\"Error fetching user data:\", userError.message)\r\n          // If we can't verify admin status, redirect to dashboard for safety\r\n          return NextResponse.redirect(new URL(\"/dashboard\", request.url))\r\n        }\r\n\r\n        if (userData?.role !== \"admin\") {\r\n          return NextResponse.redirect(new URL(\"/dashboard\", request.url))\r\n        }\r\n      } catch (error) {\r\n        console.error(\"Error in admin check:\", error)\r\n        // On error, redirect to dashboard for safety\r\n        return NextResponse.redirect(new URL(\"/dashboard\", request.url))\r\n      }\r\n    }\r\n\r\n    // ðŸš« Auth userlarni login/registerdan chiqarish\r\n    if (\r\n      user &&\r\n      (request.nextUrl.pathname === \"/login\" ||\r\n        request.nextUrl.pathname === \"/register\")\r\n    ) {\r\n      return NextResponse.redirect(new URL(\"/dashboard\", request.url))\r\n    }\r\n\r\n    // ðŸš« Login qilmaganlarni himoyalangan sahifalardan chiqarish\r\n    if (\r\n      !user &&\r\n      (request.nextUrl.pathname.startsWith(\"/dashboard\") ||\r\n        request.nextUrl.pathname.startsWith(\"/admin\") ||\r\n        request.nextUrl.pathname.startsWith(\"/test\") ||\r\n        request.nextUrl.pathname.startsWith(\"/settings\") ||\r\n        request.nextUrl.pathname.startsWith(\"/tickets\"))\r\n    ) {\r\n      return NextResponse.redirect(new URL(\"/login\", request.url))\r\n    }\r\n\r\n    return response\r\n  } catch (error) {\r\n    // If anything goes wrong, allow the request to proceed\r\n    // This prevents the proxy from blocking all requests on error\r\n    console.error(\"Proxy error:\", error)\r\n    return NextResponse.next({\r\n      request: {\r\n        headers: request.headers,\r\n      },\r\n    })\r\n  }\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    \"/dashboard/:path*\",\r\n    \"/admin/:path*\",\r\n    \"/test/:path*\",\r\n    \"/settings/:path*\",\r\n    \"/tickets/:path*\",\r\n    \"/login\",\r\n    \"/register\",\r\n  ],\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}